@model ManarangVergara.Models.DashboardViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Dashboard";
    string currentPeriod = ViewData["CurrentPeriod"] as string ?? "7days";
}

<!-- --- HEADER SECTION --- -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-dark mb-0">Operational Overview</h2>
        <p class="text-muted mb-0">Welcome back, @User.Identity.Name!</p>
    </div>

    <div class="d-flex gap-2">
        <a asp-controller="Pos" asp-action="Index" class="btn btn-success fw-bold shadow-sm">
            <i class="fa-solid fa-plus me-2"></i>New Transaction
        </a>

        @if (User.IsInRole("Admin") || User.IsInRole("Owner"))
        {
            <a asp-controller="Reports"
               asp-action="Index"
               asp-route-startDate="@DateTime.Today.ToString("yyyy-MM-dd")"
               asp-route-endDate="@DateTime.Today.ToString("yyyy-MM-dd")"
               target="_blank"
               class="btn btn-outline-primary shadow-sm">
                <i class="fa-solid fa-file-pdf me-2"></i>Daily Report
            </a>
        }
    </div>
</div>

<!-- --- KPI CARDS ROW --- -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 opacity-75"><i class="fa-solid fa-peso-sign me-1"></i>Daily Sales</h6>
                <h2 class="card-title fw-bold">₱@Model.DailyGrossProfit.ToString("N2")</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-primary shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 opacity-75"><i class="fa-solid fa-warehouse me-1"></i>Total Stock Value</h6>
                <h2 class="card-title fw-bold">₱@Model.TotalStockValue.ToString("N2")</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-dark bg-warning shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 opacity-75"><i class="fa-solid fa-triangle-exclamation me-1"></i>Low Stock</h6>
                <h2 class="card-title fw-bold">@Model.LowStockCount Products</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 opacity-75"><i class="fa-solid fa-hourglass-end me-1"></i>Near Expiry</h6>
                <h2 class="card-title fw-bold">@Model.NearExpiryCount Products</h2>
            </div>
        </div>
    </div>
</div>

<!-- --- CHARTS SECTION WITH SLICER --- -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4 mb-lg-0">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 fw-bold text-primary"><i class="fa-solid fa-chart-bar me-2"></i>Sales Trends</h6>

                <!-- UPDATED SLICER -->
                <form asp-action="Index" method="get" class="d-inline-block">
                    <select name="period" class="form-select form-select-sm fw-bold border-primary text-primary" onchange="this.form.submit()">
                        <!option value="7days" @(currentPeriod == "7days" ? "selected" : "")>Last 7 Days (Daily)</!option>
                        <!option value="30days" @(currentPeriod == "30days" ? "selected" : "")>Last 30 Days (Daily)</!option>
                        <!option value="thisyear" @(currentPeriod == "thisyear" ? "selected" : "")>This Year (Monthly)</!option>
                    </select>
                </form>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="myBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Pie Chart -->
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 fw-bold text-primary"><i class="fa-solid fa-chart-pie me-2"></i>Top Categories</h6>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <div style="height: 250px; width: 100%;">
                    <canvas id="myPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- --- ALERTS & TRANSACTIONS ROW --- -->
<div class="row">
    <div class="col-lg-7 mb-4">
        <div class="card shadow-sm h-100 border-danger">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fa-solid fa-bell me-2"></i>Proactive Alerts</h5>
                <span class="badge bg-white text-danger">@Model.ProactiveAlerts.Count Items</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>Stock</th>
                            <th>Expiry</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var alert in Model.ProactiveAlerts)
                        {
                            <tr class="@(alert.Urgency == "Critical" ? "table-danger" : "table-warning")">
                                <td class="fw-bold">@alert.ProductName</td>
                                <td>@alert.Quantity</td>
                                <td>
                                    @alert.ExpiryDate.ToString("MMM dd, yyyy")
                                    <br>
                                    <small class="text-muted">(@alert.DaysLeft days left)</small>
                                </td>
                                <td><span class="badge bg-dark">@alert.AlertType</span></td>
                            </tr>
                        }
                        @if (!Model.ProactiveAlerts.Any())
                        {
                            <tr><td colspan="4" class="text-center text-success p-3"><i class="fa-solid fa-check-circle me-2"></i>No immediate risks found!</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-5 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary"><i class="fa-solid fa-receipt me-2"></i>Recent Sales</h5>
                <a asp-controller="Transactions" asp-action="Index" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <ul class="list-group list-group-flush">
                @foreach (var txn in Model.RecentTransactions)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">#@txn.TransactionId</span>
                            <span class="badge rounded-pill bg-secondary ms-2" style="font-size: 0.8em;">
                                <i class="fa-solid fa-basket-shopping me-1"></i>@txn.ItemCount items
                            </span>
                            <br>
                            <small class="text-muted">@txn.Date.ToString("MMM dd, hh:mm tt")</small>
                        </div>
                        <div class="text-end">
                            <span class="text-success fw-bold">₱@txn.TotalAmount.ToString("N2")</span>
                            <br>
                            <span class="badge bg-light text-dark border">@txn.PaymentMethod</span>
                        </div>
                    </li>
                }
                @if (!Model.RecentTransactions.Any())
                {
                    <li class="list-group-item text-center text-muted p-4">No transactions today yet.</li>
                }
            </ul>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        var barLabels = @Html.Raw(JsonSerializer.Serialize(Model.BarChartLabels));
        var barData = @Html.Raw(JsonSerializer.Serialize(Model.BarChartData));
        var pieLabels = @Html.Raw(JsonSerializer.Serialize(Model.PieChartLabels));
        var pieData = @Html.Raw(JsonSerializer.Serialize(Model.PieChartData));

        var ctxBar = document.getElementById("myBarChart").getContext('2d');
        var myBarChart = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: barLabels,
                datasets: [{
                    label: "Revenue (₱)",
                    backgroundColor: "#4e73df",
                    hoverBackgroundColor: "#2e59d9",
                    borderColor: "#4e73df",
                    data: barData,
                    barPercentage: 0.6
                }],
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: function(value) { return '₱' + value; } }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        var ctxPie = document.getElementById("myPieChart").getContext('2d');
        var myPieChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }],
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                cutout: '70%',
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12 } }
                }
            },
        });
    </script>
}